<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDeploy - VM Preparation Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; }
        .login-container { max-width: 400px; margin: 100px auto; padding: 30px; background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .dashboard-container { display: none; padding: 20px; }
        .sidebar { position: fixed; right: 0; top: 0; width: 350px; height: 100vh; background: white; border-left: 2px solid #dee2e6; padding: 20px; overflow-y: auto; }
        .main-content { margin-right: 370px; }
        .module-group { margin-bottom: 25px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .module-checkbox { margin: 8px 0; }
        .progress-container { margin: 10px 0; display: none; }
        .log-details { display: none; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
        .terminal-container { margin-top: 20px; background: #1e1e1e; padding: 15px; border-radius: 8px; }
        .ai-chat { height: calc(100vh - 200px); display: flex; flex-direction: column; }
        .chat-messages { flex: 1; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px; padding: 10px; margin-bottom: 10px; background: #f8f9fa; }
        .chat-message { margin: 8px 0; padding: 8px; border-radius: 5px; }
        .chat-user { background: #007bff; color: white; text-align: right; }
        .chat-ai { background: #e9ecef; }
        .status-badge { font-size: 12px; margin-left: 10px; }
        .app-deploy-section { margin-top: 30px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .secret-form { margin-top: 15px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <h2 class="text-center mb-4">PDeploy Login</h2>
        <form id="loginForm">
            <div class="mb-3">
                <label class="form-label">Username</label>
                <input type="text" class="form-control" id="username" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Password</label>
                <input type="password" class="form-control" id="password" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Login</button>
        </form>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard-container">
        <div class="main-content">
            <div class="header">
                <h1>PDeploy - VM Preparation Dashboard</h1>
                <p class="mb-0">Automated Ubuntu x64 Server Setup</p>
            </div>

            <!-- Library Selection -->
            <div id="librarySelection">
                <h3>Select Libraries to Install</h3>
                
                <div class="module-group">
                    <h5>Backend Libraries</h5>
                    <div id="backendModules"></div>
                </div>

                <div class="module-group">
                    <h5>Frontend Libraries</h5>
                    <div id="frontendModules"></div>
                </div>

                <div class="module-group">
                    <h5>Server & Security</h5>
                    <div id="serverModules"></div>
                </div>

                <button id="goButton" class="btn btn-success btn-lg mt-3">
                    <span id="goButtonText">Start Installation</span>
                    <span id="goButtonSpinner" class="spinner-border spinner-border-sm ms-2" style="display:none;"></span>
                </button>
            </div>

            <!-- Progress Section -->
            <div id="progressSection" class="mt-4"></div>

            <!-- App Deployment -->
            <div class="app-deploy-section">
                <h3>Application Deployment</h3>
                <p class="text-muted">Deploy your application after libraries are installed</p>
                <div class="mb-3">
                    <label class="form-label">Repository URL</label>
                    <input type="text" class="form-control" id="repoUrl" placeholder="https://github.com/username/repo">
                </div>
                <button id="deployButton" class="btn btn-primary">Deploy Application</button>
                <div id="deployProgress" class="mt-3"></div>
            </div>

            <!-- Terminal -->
            <div class="terminal-container">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="text-white mb-0">Terminal Output</h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="terminalInteractive">
                        <label class="form-check-label text-white" for="terminalInteractive">Interactive Mode</label>
                    </div>
                </div>
                <div id="terminal"></div>
            </div>
        </div>

        <!-- AI Chat Sidebar -->
        <div class="sidebar">
            <h4>AI Assistant</h4>
            <div class="mb-3">
                <label class="form-label">AI Provider</label>
                <select class="form-select" id="aiProvider">
                    <option value="grok">Grok API</option>
                    <option value="ollama">Ollama (Local)</option>
                    <option value="openai">OpenAI</option>
                </select>
            </div>
            <div class="ai-chat">
                <div class="chat-messages" id="chatMessages"></div>
                <div>
                    <textarea class="form-control mb-2" id="chatInput" rows="3" placeholder="Ask AI for help..."></textarea>
                    <button class="btn btn-primary w-100" id="sendChatButton">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script>
        // Global state
        const state = {
            selectedModules: [],
            installationLogs: {},
            repoTree: null,
            aiContext: []
        };

        const GITHUB_REPO = 'Cellsave/dev-gen';
        const GITHUB_API = `https://api.github.com/repos/${GITHUB_REPO}/git/trees/main?recursive=1`;

        // Terminal setup
        const term = new Terminal({
            cursorBlink: true,
            theme: { background: '#1e1e1e' },
            rows: 20
        });

        // Login handling
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Simple local auth (stored in localStorage)
            localStorage.setItem('pdeploy_user', username);
            localStorage.setItem('pdeploy_auth', btoa(`${username}:${password}`));
            
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            
            initDashboard();
        });

        // Initialize dashboard
        async function initDashboard() {
            term.open(document.getElementById('terminal'));
            term.writeln('PDeploy Terminal - Ready');
            term.writeln('');

            // Load cached repo tree or fetch new
            const cached = localStorage.getItem('pdeploy_repo_tree');
            if (cached) {
                state.repoTree = JSON.parse(cached);
                renderModules();
            }

            await fetchRepoTree();
            addAIMessage('Hello! I\'m your AI assistant. I\'ll monitor installations and help troubleshoot issues.', 'ai');
        }

        // Fetch GitHub repo tree
        async function fetchRepoTree() {
            try {
                term.writeln('Fetching module list from GitHub...');
                const response = await fetch(GITHUB_API);
                const data = await response.json();
                
                state.repoTree = data.tree.filter(item => 
                    item.type === 'tree' && 
                    (item.path.startsWith('modules/') || item.path.includes('docker') || item.path.includes('node'))
                );
                
                localStorage.setItem('pdeploy_repo_tree', JSON.stringify(state.repoTree));
                renderModules();
                term.writeln('Module list updated successfully');
            } catch (error) {
                term.writeln(`Error fetching modules: ${error.message}`);
                addAIMessage('Failed to fetch modules from GitHub. Using cached version if available.', 'ai');
            }
        }

        // Render module checkboxes
        function renderModules() {
            const modules = {
                backend: ['docker', 'node22', 'sqlite'],
                frontend: ['react18'],
                server: ['linux-tools']
            };

            Object.keys(modules).forEach(category => {
                const container = document.getElementById(`${category}Modules`);
                container.innerHTML = '';
                
                modules[category].forEach(module => {
                    const div = document.createElement('div');
                    div.className = 'module-checkbox form-check';
                    div.innerHTML = `
                        <input class="form-check-input" type="checkbox" value="${module}" id="${module}">
                        <label class="form-check-label" for="${module}">
                            ${formatModuleName(module)}
                        </label>
                    `;
                    container.appendChild(div);
                });
            });
        }

        // Format module name for display
        function formatModuleName(name) {
            const names = {
                'docker': 'Docker',
                'node22': 'Node.js 22 (with Express, TypeScript)',
                'sqlite': 'SQLite',
                'react18': 'React 18 (with TS, Vite, Tailwind, Monaco, D3)',
                'linux-tools': 'Linux Tools (Essential packages)'
            };
            return names[name] || name;
        }

        // Start installation
        document.getElementById('goButton').addEventListener('click', async () => {
            const checkboxes = document.querySelectorAll('.module-checkbox input:checked');
            state.selectedModules = Array.from(checkboxes).map(cb => cb.value);

            if (state.selectedModules.length === 0) {
                alert('Please select at least one module to install');
                return;
            }

            document.getElementById('goButtonText').textContent = 'Installing...';
            document.getElementById('goButtonSpinner').style.display = 'inline-block';
            document.getElementById('goButton').disabled = true;

            addAIMessage(`Starting installation of ${state.selectedModules.length} modules: ${state.selectedModules.join(', ')}`, 'ai');

            await runInstallations();

            document.getElementById('goButtonText').textContent = 'Installation Complete';
            document.getElementById('goButtonSpinner').style.display = 'none';
        });

        // Run installations sequentially
        async function runInstallations() {
            const progressSection = document.getElementById('progressSection');
            progressSection.innerHTML = '<h4>Installation Progress</h4>';

            for (const module of state.selectedModules) {
                await installModule(module);
            }

            addAIMessage('All installations completed! You can now deploy your application.', 'ai');
        }

        // Install individual module
        async function installModule(moduleName) {
            const progressSection = document.getElementById('progressSection');
            
            const moduleDiv = document.createElement('div');
            moduleDiv.className = 'module-group';
            moduleDiv.id = `module-${moduleName}`;
            moduleDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <h6>${formatModuleName(moduleName)}</h6>
                    <span class="status-badge badge bg-warning">Installing...</span>
                </div>
                <div class="progress mt-2">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>
                <button class="btn btn-sm btn-link mt-2" onclick="toggleLogs('${moduleName}')">Show Details</button>
                <div class="log-details" id="logs-${moduleName}"></div>
            `;
            progressSection.appendChild(moduleDiv);

            term.writeln(`\n=== Installing ${formatModuleName(moduleName)} ===`);

            try {
                // Simulate installation with progress updates
                await simulateInstallation(moduleName);
                
                // Update status
                const badge = moduleDiv.querySelector('.status-badge');
                badge.className = 'status-badge badge bg-success';
                badge.textContent = 'Success';
                
                const progressBar = moduleDiv.querySelector('.progress-bar');
                progressBar.style.width = '100%';
                progressBar.classList.remove('progress-bar-animated');
                
                term.writeln(`✓ ${formatModuleName(moduleName)} installed successfully`);
                addAIMessage(`${formatModuleName(moduleName)} installed successfully!`, 'ai');
                
            } catch (error) {
                const badge = moduleDiv.querySelector('.status-badge');
                badge.className = 'status-badge badge bg-danger';
                badge.textContent = 'Failed';
                
                term.writeln(`✗ ${formatModuleName(moduleName)} installation failed: ${error.message}`);
                addAIMessage(`Installation failed for ${formatModuleName(moduleName)}. Error: ${error.message}. Would you like me to suggest a fix?`, 'ai');
            }
        }

        // Simulate installation (in production, this would call actual scripts)
        async function simulateInstallation(moduleName) {
            const steps = ['pre_check', 'install', 'configure', 'validate'];
            const progressBar = document.querySelector(`#module-${moduleName} .progress-bar`);
            const logsDiv = document.getElementById(`logs-${moduleName}`);

            for (let i = 0; i < steps.length; i++) {
                const step = steps[i];
                const progress = ((i + 1) / steps.length) * 100;
                
                progressBar.style.width = `${progress}%`;
                
                const logEntry = `[${new Date().toLocaleTimeString()}] ${step}: Processing...`;
                logsDiv.innerHTML += `${logEntry}\n`;
                term.writeln(`  ${logEntry}`);
                
                // Simulate step execution time
                await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 1000));
            }
        }

        // Toggle log details
        function toggleLogs(moduleName) {
            const logsDiv = document.getElementById(`logs-${moduleName}`);
            const button = event.target;
            
            if (logsDiv.style.display === 'none' || !logsDiv.style.display) {
                logsDiv.style.display = 'block';
                button.textContent = 'Hide Details';
            } else {
                logsDiv.style.display = 'none';
                button.textContent = 'Show Details';
            }
        }

        // App deployment
        document.getElementById('deployButton').addEventListener('click', async () => {
            const repoUrl = document.getElementById('repoUrl').value.trim();
            
            if (!repoUrl) {
                alert('Please enter a repository URL');
                return;
            }

            const deployProgress = document.getElementById('deployProgress');
            deployProgress.innerHTML = '<div class="alert alert-info">Analyzing repository...</div>';
            
            term.writeln(`\n=== Deploying Application ===`);
            term.writeln(`Repository: ${repoUrl}`);
            
            addAIMessage(`Analyzing repository ${repoUrl}. I'll determine the best deployment method based on installed libraries.`, 'ai');
            
            // Simulate AI decision making
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const hasDocker = state.selectedModules.includes('docker');
            const deployMethod = hasDocker ? 'Docker' : 'Script-based';
            
            addAIMessage(`Based on installed libraries, I recommend ${deployMethod} deployment. Proceeding...`, 'ai');
            
            deployProgress.innerHTML = `
                <div class="alert alert-success">
                    Deployment method: ${deployMethod}<br>
                    Status: In progress...
                </div>
            `;
            
            term.writeln(`Deployment method: ${deployMethod}`);
            term.writeln('Cloning repository...');
            
            // Simulate deployment
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            deployProgress.innerHTML = `
                <div class="alert alert-success">
                    ✓ Application deployed successfully!<br>
                    Method: ${deployMethod}
                </div>
            `;
            
            term.writeln('✓ Application deployed successfully');
            addAIMessage('Application deployed successfully! Your VM is ready to use.', 'ai');
        });

        // AI Chat
        document.getElementById('sendChatButton').addEventListener('click', () => {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message) {
                addAIMessage(message, 'user');
                input.value = '';
                
                // Simulate AI response
                setTimeout(() => {
                    const response = generateAIResponse(message);
                    addAIMessage(response, 'ai');
                }, 500);
            }
        });

        // Add message to chat
        function addAIMessage(text, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message chat-${sender}`;
            messageDiv.textContent = text;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            state.aiContext.push({ sender, text, timestamp: Date.now() });
        }

        // Generate AI response (simplified)
        function generateAIResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('error') || lowerMessage.includes('fail')) {
                return 'I see you\'re experiencing an issue. Can you provide more details about the error? Check the terminal logs for specific error messages.';
            } else if (lowerMessage.includes('docker')) {
                return 'Docker is a containerization platform. Make sure it\'s selected in the Backend Libraries section before installation.';
            } else if (lowerMessage.includes('help')) {
                return 'I can help you with:\n- Module selection and installation\n- Troubleshooting errors\n- Application deployment\n- General VM setup questions';
            } else {
                return 'I\'m monitoring your installation progress. Feel free to ask any questions about the setup process!';
            }
        }

        // Terminal interactive mode
        document.getElementById('terminalInteractive').addEventListener('change', (e) => {
            if (e.target.checked) {
                term.writeln('\n[Interactive mode enabled - Feature in development]');
                addAIMessage('Interactive terminal mode is currently in development. You can view logs in read-only mode.', 'ai');
            } else {
                term.writeln('\n[Interactive mode disabled]');
            }
        });

        // Check if already logged in
        if (localStorage.getItem('pdeploy_user')) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            initDashboard();
        }
    </script>
</body>
</html>
